# ML System Design Document: Harry Potter RAG

## 1. Зачем идем в разработку продукта?

Цель проекта — создать интерактивную систему, позволяющую пользователям задавать вопросы по сюжету, персонажам и деталям книг серии «Гарри Поттер» и получать точные ответы с прямыми цитатами из текста и указанием источника (название книги и номер главы). Это решает проблему трудоёмкого поиска информации в объёмных текстах и обеспечивает прозрачность: пользователь видит, откуда взят ответ. Система включает backend (FastAPI) и frontend (React), а генерация ответов выполняется с помощью Mistral AI API (бесплатная версия)

## 2. Бизнес-требования и ограничения

*   **Функциональные требования:**
    *   Система принимает текстовый вопрос от пользователя через веб-интерфейс (React).
    *   Backend (FastAPI) обрабатывает запрос, ищет релевантные фрагменты в книгах с сохранением метаданных (`book`, `chapter`).
    *   Система формирует промпт и отправляет его в **Mistral AI API**.
    *   Полученный ответ структурируется и возвращается с **прямой цитатой** и **ссылкой на источник** (например: *«Гарри Поттер и Орден Феникса, глава 37»*).
    *   Ответ отображается на фронтенде.

*   **Нефункциональные требования:**
    *   Ответы должны быть основаны **только на предоставленном контексте** (ретривнутых фрагментах).
    *   Время отклика — до **10–15 секунд** (с учётом задержек Mistral API).
    *   MVP должен быть реализован за **2 месяца**.
    *   Качество будет оценено вручную на **30–50 вопросах**; целевой порог — ≥80% ответов с корректной цитатой и источником.

*   **Ограничения:**
    *   Используются только тексты книг (7 томов), полученные из открытых источников (например, [Flibusta](https://flibusta.site)) **в образовательных целях**.
    *   Зависимость от **Mistral AI API**: требуется интернет и API-ключ.
    *   Бесплатный тариф Mistral может иметь **ограничения по количеству запросов/токенов в минуту** — система должна обрабатывать ошибки (429 Too Many Requests).
    *   Поддержка только одного языка (язык исходного текста: русский или английский).
    *   На этапе MVP не предполагается поддержка истории диалога или сложной логики.

## 3. Что входит в скоуп проекта/итерации, что не входит

*   **Входит:**
    *   Предобработка текстов: парсинг, разбиение по главам, извлечение метаданных (`book`, `chapter`).
    *   Векторизация чанков с привязкой к метаданным.
    *   Локальное векторное хранилище (FAISS или Chroma).
    *   RAG-пайплайн: ретривер + формирование промпта + вызов **Mistral API**.
    *   Backend на **FastAPI** с эндпоинтом `/ask`, включающим обработку ошибок API.
    *   Frontend на **React** с полем ввода и отображением: ответ, цитата, источник.
    *   Использование **бесплатной версии Mistral API** (модель, например, `mistral-small-latest` или `open-mistral-7b`).

*   **Не входит:**
    *   Локальный запуск LLM (всё генерация — через Mistral API).
    *   Кэширование ответов или запросов (в MVP).
    *   Мультиязычная поддержка.
    *   История чата, авторизация, админка.
    *   Поддержка других серий книг или внешних источников (вики, фильмы).

## 4. Предпосылки решения

Mistral AI предоставляет бесплатный доступ к мощным open-weight моделям с низкой задержкой и хорошим качеством генерации. Это позволяет сосредоточиться на RAG-логике, а не на развертывании LLM локально. Наличие структурированного текста с главами даёт возможность точного цитирования. Архитектура FastAPI + React обеспечивает чёткое разделение backend и frontend.

## 5. Постановка задачи

Реализовать систему, которая по вопросу пользователя (например, *«Почему Добби освободился от семьи Малфоев?»*) возвращает структурированный ответ:

> **Ответ**: Добби освободился, потому что Люциус Малфой случайно дал ему носок — предмет одежды, что по законам домовиков означает освобождение.  
> **Цитата**: *«Ты не должен был давать мне носок!» — воскликнул Люциус Малфой, глядя на Добби с ненавистью.*  
> **Источник**: *«Гарри Поттер и Тайная комната», глава 18*

**Основная метрика успеха**:  
— ≥80% ответов на тестовом наборе из 30–50 вопросов содержат релевантную цитату и корректно указанную книгу и главу.

### 5.1. Ручная оценка
- **Объём**: 30–50 вопросов, охватывающих факты, сюжет, мотивации персонажей.
- **Трудозатраты**: ~2 минуты на вопрос → **1–1.5 часа** на одного оценщика.
- **Процедура**: два участника независимо оценивают; согласованность фиксируется.

### 5.2. Автоматизированная оценка (опционально)
- `hit_rate@5` для ретривера.
- Логирование ошибок Mistral API (429, 5xx) для анализа надёжности.

> Финальное решение о качестве — по результатам ручной оценки.

## 6. Блок-схема решения

[Пользователь вводит вопрос в React-интерфейсе]
                     ↓
       [POST /ask → FastAPI backend]
                     ↓
[Retriever: поиск топ-K чанков + извлечение metadata (book, chapter)]
                     ↑
[Векторное хранилище ← Тексты книг, размеченные по главам]
                     ↓
[Формирование промпта для Mistral API:
 "Ответь ТОЛЬКО на основе приведённых ниже отрывков.
  Обязательно включи ПРЯМУЮ ЦИТАТУ из текста и укажи НАЗВАНИЕ КНИГИ и НОМЕР ГЛАВЫ.
  Не выдумывай информацию."]
                     ↓
        [Запрос к Mistral AI API (через HTTP)]
                     ↓
    [Обработка ответа: извлечение/валидация цитаты и источника]
                     ↓
 [FastAPI возвращает JSON: {answer: str, quote: str, source: str}]
                     ↓
   [React отображает ответ, цитату и источник пользователю]